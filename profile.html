<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Perfil do Usu√°rio</title>
</head>

<body class="home">
    <div class="titles">
        <h1>FORMUL√ÅRIO FUNCIONAL</h1>
        <hr style="color: rgb(255, 255, 255)">
        <br>
        <h3>Esse projeto tem essas especifica√ß√µes:</h3>
        <h3>Front-end: HTML, CSS e JS</h3>
        <h3>Back-end: PYTHON</h3>
        <h3>SGBD: MYSQL</h3>
    </div><br><br>

    <form>

        <!-- mostra as suas informa√ß√µes -->
        <fieldset>
            <legend>MAIS INFORMA√á√ïES AQUI</legend><br>
            <div id="userData" class="profile-data"></div>
        </fieldset><br><br>
        <br><br><br>

        <!-- mostra os outros usuarios -->
        <fieldset>
            <legend>OUTROS USU√ÅRIOS REGISTRADOS</legend>
            <div id="listaUsuarios" class="profile-data"></div>
            <ul id="listaNomes" style="color:white; padding: 20px; margin:10px"></ul>
            </div>
        </fieldset><br><br>
        <br><br><br>


        <!-- volta pro login -->
        <p style="color: rgb(255,255,255); text-align: center;">
            <a class="links" href="index.html">VOLTAR PARA FAZER LOGIN</a>
        </p> <br>

        <!-- sai da conta -->
        <p style="color: rgb(255,255,255); text-align: center;">
            <button id="logoutBtn" class="links">SAIR DESTA CONTA</button>
        </p><br><br>
        <br><br><br>

        <!-- apagar a conta -->
        <p style="color: rgb(255,255,255); text-align: center;">
            <button id="deleteAccountBtn" class="links LinksDelete">
                APAGAR ESTA CONTA</button>
        </p><br><br>
        <br><br><br>

        <fieldset>
            <!-- upload de arquivos -->
            <legend>SEUS ARQUIVOS</legend>
            <input type="file" id="fileInput"> <!--escolher arquivo-->
            <br><br>
            <button type="button" class="links" onclick="uploadArquivo()">Enviar Arquivo</button>
            <!--fun√ß√£o JS que manda pro back-->
            <ul id="listaArquivos"></ul> <!--onde aparecem os arquivos j√° upados-->
            <br><br>
            <hr>
            <br>
            <button type="button" class="links LinksDelete" onclick="resetarArquivos()">Resetar Arquivos Padr√£o</button>
            <!--reseta tudo pros arquivos padr√£o-->
            <br><br>
        </fieldset>

    </form>

    <script>
        const userData = JSON.parse(localStorage.getItem("UserData")); // pega do localStorage os dados do user salvos como JSON
        const container = document.getElementById("userData"); // seleciona o lugar onde vai mostrar os dados

        if (userData) {
            // formata√ß√£o dos dados
            // transforma a data bruta em formato brasileiro, dd/mm/aaaa
            const formatDate = (dateString) => {
                const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                return new Date(dateString).toLocaleDateString('pt-BR', options);
            };

            // formata telefone no padr√£o brasileiro usando regex, (10) 01234-5678
            const formatPhone = (phone) => {
                return phone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            };

            // injeta os dados do usu√°rio no HTML e se n√£o tiver algo salvo, mostra a mensagem de erro
            let html = `
                <div class="profile-field">
                    <label>Nome de usu√°rio:</label>
                    <div class="profile-value">${userData.UserName}</div>
                </div>
                
                <div class="profile-field">
                    <label>Nome completo:</label>
                    <div class="profile-value">${userData.FirstName} ${userData.Surname}</div>
                </div>
                
                <div class="profile-field">
                    <label>E-mail:</label>
                    <div class="profile-value">${userData.Email}</div>
                </div>
                
                <div class="profile-field">
                    <label>Telefone:</label>
                    <div class="profile-value">${formatPhone(userData.Telephone)}</div>
                </div>
                
                <div class="profile-field">
                    <label>Data de nascimento:</label>
                    <div class="profile-value">${formatDate(userData.DateOfBirth)}</div>
                </div>
                
                <div class="profile-field">
                    <label>G√™nero:</label>
                    <div class="profile-value">${userData.Gender}</div>
                </div>
                
                <div class="profile-field">
                    <label>Coment√°rio:</label>
                    <div class="profile-value comment-value">${userData.CommentRecord}</div>
                </div>
            `;

            container.innerHTML = html;


            // busca e mostra todos os cadastrados, lista de usu√°rios via API
            // faz uma requisi√ß√£o pro back (flask) pra pegar todos os nomes e mete cada um como <li>, que ta dentro da <ul>
            fetch("http://localhost:5000/listar_usuarios")
                .then(response => response.json())
                .then(data => {
                    const ul = document.getElementById("listaNomes");
                    if (data.status === "ok") {
                        data.usuarios.forEach(nome => {
                            const li = document.createElement("li");
                            li.textContent = nome;
                            ul.appendChild(li);
                        });
                    } else { // mensagem de erro
                        ul.innerHTML = "<li>Erro ao carregar usu√°rios</li>";
                    }
                })
                .catch(error => { // mensagem de erro
                    document.getElementById("listaNomes").innerHTML = "<li>Falha na requisi√ß√£o</li>";
                    console.error("Erro ao buscar usu√°rios:", error);
                });


        } else { // mensagem de nenhum usu√°rio
            container.innerHTML = `
                <div style="color: white; text-align: center; padding: 20px;">
                    <p>NENHUM USU√ÅRIO IDENTIFICADO<br><br></p>
                </div>
            `;
        }


        // apaga os dados locais (apaga user do localStorage)
        document.getElementById("logoutBtn").addEventListener("click", function (e) {
            e.preventDefault(); // impede envio de form
            localStorage.removeItem("UserData"); // apaga user
            window.location.href = "index.html"; // redireciona pro login
        });

        // quando clica, manda um POST pra /deletar_conta, confirmando antes, e se der certo, exclui dados locais e manda pro login
        document.getElementById("deleteAccountBtn").addEventListener("click", async function (e) {
            e.preventDefault();

            if (!confirm("Tem certeza que quer apagar essa conta? Isso √© IRREVERS√çVEL!")) return; // mensagem de aviso

            const response = await fetch("http://localhost:5000/deletar_conta", { // espera da requisi√ß√£o
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ UserName: userData.UserName })
            });

            const resultado = await response.json(); // espera da requisi√ß√£o

            if (response.ok && resultado.status === "ok") {
                alert("Conta deletada. Adeus, guerreiro(a)!"); // mensagem de despedida
                localStorage.removeItem("UserData"); // apaga user
                window.location.href = "index.html"; // redireciona pro login
            } else { // mensagem de erro
                alert("Erro ao deletar conta: " + (resultado.mensagem || "Desconhecido"));
            }
        });


        // pega arquivo e cria FormData e depois manda pro back com fetch, se tiver sucesso, ele chama listarArquivos() pra atualizar a lista
        function uploadArquivo() {
            const file = document.getElementById("fileInput").files[0];
            if (!file) return alert("Selecione um arquivo primeiro!"); // mensagem de aviso

            const formData = new FormData();
            formData.append("arquivo", file);
            formData.append("UserName", userData.UserName);

            fetch("http://localhost:5000/upload", {
                method: "POST",
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.mensagem);
                    listarArquivos();
                })
                .catch(err => alert("Erro no upload: " + err.message)); // mensagem de erro
        }


        // puxa do flask os arquivos do user e cria <li> com link e bot√£o de lixeira
        function listarArquivos() {
            fetch(`http://localhost:5000/listar_arquivos/${userData.UserName}`)
                .then(res => res.json())
                .then(data => {
                    const lista = document.getElementById("listaArquivos");
                    lista.innerHTML = "";
                    data.arquivos.forEach(arq => {
                        const li = document.createElement("li");
                        li.innerHTML = `
    <a href="http://localhost:5000/download/${arq}" target="_blank">${arq}</a>
    <button onclick="event.preventDefault(); deletarArquivo('${arq}')"
            style="margin-left: 10px;">üóëÔ∏è</button>
`;
                        lista.appendChild(li);
                    });
                });
        }


        // confirma antes, assim depois, manda pro endpoint /deletar_arquivo
        function deletarArquivo(nomeArquivo) {
            if (!confirm(`Deseja mesmo apagar o arquivo "${nomeArquivo}"?`)) return; // mensagem de aviso

            fetch("http://localhost:5000/deletar_arquivo", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ filename: nomeArquivo })
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.mensagem);
                    listarArquivos();
                })
                .catch(err => alert("Erro ao deletar: " + err.message)); // mensagem de erro
        }
        window.onload = listarArquivos;


        // confirma antes, assim depois, manda pro /resetar_arquivos
        function resetarArquivos() {
            if (!confirm("Tem certeza que quer resetar seus arquivos? Isso vai apagar os atuais!")) return; // mensagem de aviso

            fetch("http://localhost:5000/resetar_arquivos", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ UserName: userData.UserName })
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.mensagem);
                    listarArquivos();
                })
                .catch(err => alert("Erro ao resetar arquivos: " + err.message)); // mensagem de erro
        }


    </script>
</body>

</html>